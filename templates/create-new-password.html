{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dangos Smart Reply</title>
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <link rel="icon" type="image/x-icon" href="{% static 'assets/img/favicon.ico' %}">
    <style>
        body { font-family: Arial, sans-serif; background:#f6f9fc; margin:0; padding:0; }
        .container { max-width: 420px; margin: 40px auto; background:#fff; padding: 24px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
        h2 { margin-top:0; color:#093d89; }
        label { display:block; margin:12px 0 6px; }
        input[type="password"] { width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; }
        button { margin-top:16px; width:100%; padding:12px; background:#093d89; color:#fff; border:none; border-radius:6px; cursor:pointer; }
        .msg { margin-top:12px; font-size:14px; }
        .error { color:#c1121f; }
        .success { color:#2b9348; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Create New Password</h2>
        <p>Enter your new password below.</p>

        <form id="resetForm">
            <label for="password">New Password</label>
            <input type="password" id="password" name="password" required minlength="6" />
            <label for="confirm">Confirm Password</label>
            <input type="password" id="confirm" name="confirm" required minlength="6" />
            <button type="submit">Create New Password</button>
            <div id="msg" class="msg"></div>
        </form>
    </div>

    <script>
        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        const form = document.getElementById('resetForm');
        const msgEl = document.getElementById('msg');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            msgEl.textContent = '';
            msgEl.className = 'msg';

            const token = getQueryParam('token');
            const password = document.getElementById('password').value;
            const confirm = document.getElementById('confirm').value;

            if (!token) {
                msgEl.textContent = 'Missing token in URL.';
                msgEl.classList.add('error');
                return;
            }
            if (password !== confirm) {
                msgEl.textContent = 'Passwords do not match.';
                msgEl.classList.add('error');
                return;
            }

            try {
                const resp = await fetch('/api/dangos-smart-reply/v1/authentication/reset-password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, new_password: password })
                });
                const data = await resp.json();
                if (resp.ok) {
                    msgEl.textContent = 'New password created successfully. You can close this page.';
                    msgEl.classList.add('success');
                    form.reset();
                } else {
                    msgEl.textContent = data.message || 'Failed to create new password.';
                    msgEl.classList.add('error');
                }
            } catch (err) {
                msgEl.textContent = 'Network error.';
                msgEl.classList.add('error');
            }
        });
    </script>
</body>
</html>